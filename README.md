# FDX68_PC98_mini

<b>1. 概要</b><BR>
NECのPC-9800シリーズにFDX68を接続し、実FDDと切り替えるためのボードです。FDX68のエミュレーションモードおよびコントローラーモードをサポートしており、実FDDとしては3.5インチ(3モード可)×1台、あるいは3.5インチ1台+5インチ1台での使用を想定しています。ミカエル氏のFDS+と比べると低機能ですが、その分簡単に製作でき、DIP品のICのみで設計してあるのにもかかわらず小型化できました。

<b>2. 制限事項</b><BR>
簡素なつくりのため、FDS+と比べ機能制限が多いです。エミュレーションモードでのドライブ番号(0のみ、1のみ、0/1両方)はジャンパーで設定するようになっており、動的な変更はできません。

<b>3. ファイルの配置</b><BR>
KiCad : KiCadプロジェクトファイル<BR>
Tiny13 : マイコン(ATtiny13A)のファームウェア(AtmelStudio用ソース)<BR>
Firmware : マイコン(ATtiny13A)のファームウェア(バイナリ)<BR>
preview.png : 基板のプレビューイメージ<BR>
scheme.png : 基板回路図<BR>
  
<b>4. 接続方法</b><BR>
マザーボードとの接続用(J1)および3.5インチFDD接続用(J2)のコネクターは30ピンタイプ(A-MateやFellowのマザーボードコネクターと同じタイプ)を、FDX68接続用(J3)および5インチFDD接続用(J4)のコネクターは34ピンタイプ(一般的なマザーボード上34ピンFDDコネクターと同じタイプ)を使用しています。いずれも左上(印のついている)ピンが1番ピンになっていますので、向きを間違えないように接続してください。J1, J3には<b>反転していない</b>ストレートのケーブルを使用します。FDX68のコネクターは一般的なPC98用3.5インチFDDとは向きが逆になっていますので注意してください。マザーボードとの接続は、同じ30ピンのコネクターを搭載している機種であれば単純なストレートのケーブルでOKですが、34ピンのコネクター搭載機種だと変換ケーブルの作成が必要です。その場合、基板への電源供給ができませんので、変換ケーブルを作成する際にVCCピン(1,3,5)に電源を接続するか、操作スイッチなどを接続するJ5のVCC("+"表示のある1番ピン)から電源を供給するようにしてください。<BR><BR>
なお、J5(操作スイッチ接続コネクター)のピンアサインは下記のとおりです。<BR><BR>
Pin 1 (+) : VCC (J1のVCCピンと直結)<BR>
Pin 2 (L) : モード表示LED出力(Active Low)<BR>
Pin 3 (S) : 操作ボタン入力(Active Low)<BR>
Pin 4 (I) : RasPi電源検知入力(Active High)<BR>
Pin 5 (-) : GND<BR><BR>
モード表示LEDはアノードをVCC(Pin 1)に、カソードをLED出力(Pin 2)に接続します。電流制限抵抗は不要です。また、操作ボタン(タクトスイッチなどでOKです)はボタン入力(Pin 4)とGND(Pin 5)の間に接続します。プルアップ抵抗などは不要です。Pin 4はFDX68(Raspberry Pi)の電源状態を検知して自動的にモードを切り替えるための入力で、Raspberry PiあるいはFDX68シールドの+5V端子を接続すればよいのですが、後述のジャンパー設定にてOPT2端子を検知に使用する場合には使用する必要はありません。また、電源検知機能を使用したくない場合にはソースコード settings.h の "#define PWRSENS 2" の行をコメントアウトしてコンパイルしてください。<BR>
 
<b>5. 設定用ジャンパー</b><br>
基板上のジャンパー(ピンヘッダー、はんだジャンパー)の一覧です。<br>
JP1 : PWR_SENS<br>
　電源検知機能を使用する場合に、検知用の信号をOPT2から取りたい場合にショートします。<br>
　FDX68のID設定を0,1とするとOPT2端子は電源ON時常にプルアップ状態になることを利用しています。<br>
JP2 : DS1 Select<br>
JP3 : DS0 Select<br>
　マザーボードからのDrive select(DS) 0/1信号を3.5インチFDDとFDX68(or 5インチFDD)のどちらに接続するかを設定します。<br>
　コントローラーモードにおいてはマザーボードからのDS信号が切り離され、DS0/1いずれもFDX68に直結されます。<br>
　FDX側をショートするとエミュレーションモードにおいて当該ドライブ番号側がエミュレートされます。<br>
　また、後述のノンエミュレーションモードにおいては5インチFDDが選択されるようになります。<br>
　3.5FD側をショートすると、当該ドライブ番号側は常に3.5インチFDDが選択されるようになります。<br>
JP4 : P4 SELECT (MS0)<br>
　FDX68のPin4を3.5インチFDDのMode Select(MS) 0に接続したい場合にショートします。<br>
　これを利用すると、3モードFDDを利用して1.44MBのFDのダンプ、リストアができるようになります。<br>
　この機能を利用して1.44MBのFDを扱うにはダンプ、リストア時に"-p4"オプションを指定すればOKです。<br>
　また、この機能は3.5インチFDD 0でのみ使用可能です(MS1には未接続のため)。<br>
JP6 : P4 SELECT (HL)<br>
　FDX68のPin4を5インチFDDのHead Load(HL)に接続し、コントローラーモードの"-p4"オプションで制御したい場合にショートします。<br>
　この基板では5インチFDDのHL端子をマザーボードと接続していませんので、通常はドライブ側でHL機能を無効化してください。<br>
JP7 : HL<br>
　5インチFDDのPin4(HL/In Use)をGNDに落としたい場合にショートします。<br>
　HLを無効化したFDDでアクセスランプが点かない場合に、ショートすることにより点くようになることが多いかと思います。<br>
  
<b>6. FDDタイプ別設定例</b><br>
以下にFDDのタイプ別の接続方法、設定方法を示します。<br>
<b>a. 3.5インチFDD×1台のみの場合</b><br>
26ピンのFDD(FD1138Tなど)であればA-Mate, Fellowなどに使用されている30ピン-26ピンケーブルで接続しますが、34ピンコネクターを持つFDD(FD1231Tなど)では変換ケーブルが必要となります。2股ケーブルを使用することによりDrive0, Drive1いずれにも設定可能です。JP2/3はFDDに設定したID側を3.5FDに、そうでない側をFDXに設定します。<br>
<b>b. 3.5インチFDD×2台の場合(1)</b><br>
2股ケーブルを使用することで2台ともJ2に接続することも可能ですが、その場合機能の組み合わせに制限が生じます。<br>
JP2/3を3.5FD側に設定したドライブ番号：本体から認識可能　エミュレーション利用不可<br>
JP2/3をFDX側に設定したドライブ番号：本体から認識不可　エミュレーション利用可能<br>
いずれのドライブもコントローラーモードでFDX68側から制御することは可能です("-i"オプションでドライブ番号を指定)<br>
<b>c. 3.5インチFDD×2台の場合(2)</b><br>
応用として、あえて片方をJ4(5インチFDD接続用)に接続するという方法があります。J4に接続したドライブは3モードでの利用はできませんが、ノンエミュレーションモードにて2ドライブとも本体から認識可能となります。この方法を利用する場合、HL機構を持たないドライブではJP7はオープンでよいと思います。接続ケーブルは通常コネクターの向きが反転したケーブルでよいと思いますが、FDD側のコネクターをよく確認するようにしてください。また、3モードFDDを使用する場合にはケーブルの1番ピンをカットする必要があります。JP2/JP3設定は下記のようにします。<br>
J2に接続したドライブ(DS0/1)を3.5FD側に設定、J4に接続したドライブ(DS1/0)をFDX側に設定<br>
以上の設定で、ノンエミュレーションモードでは2台ともアクセス可能、エミュレーションモードではJ2側のFDD+FDX68、コントローラーモードでは2台とも制御可能となります。<br>
<b>d. 3.5インチFDD×1台+5インチFDD×1台の場合</b><br>
もともとこの基板はこの組み合わせて使用することを想定して設計し、動作確認もOSD-U+FD1155Dを各1台接続して行っています。基本的な設定、接続はc.と同じです。動作確認済み5インチFDDにおけるジャンパー設定内容を示します。なお、FDX68では5インチ2D/2DDは300rpmで使用することが想定されており、コントローラーモードでの使用を考えるとドライブの回転数を300rpmに設定する必要があるため、下記の設定ではそうしています。ただし、その場合には本体から2D/2DDディスクを読み書きすることはできなくなります。<br>
FD1155(無印)  <br>
FD1155D(初期型？) <br>
FD1155D(後期型？) <br>


