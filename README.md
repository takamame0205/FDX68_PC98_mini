# PC-98用 FDX68/FDD 簡易切り替えボード

<b>1. 概要</b><BR>
NECのPC-9800シリーズにGIMONS氏開発のフロッピーエミュレーターFDX68を接続し、実FDDと併用するための実験用ボードです。FDX68のエミュレーションモードおよびコントローラーモードをサポートしており、実FDDとしては3.5インチ(3モード可)×1台、あるいは3.5インチ1台+5インチ1台での使用を想定しています。ミカエル氏のFDS+と比べると低機能ですが、その分簡単に製作でき、DIP品のICのみで設計してあるのにもかかわらず小型化することができました。なお、このボードは私個人が研究目的で作成したもので、開発途上のものです。今後の開発の参考とするためには様々な環境での検証が必要ですが、私個人でそれを行うことには限界があります。興味を持っていただけた方がおられましたら動作検証などにご協力いただければ幸いです。ちなみにこちらでは、PC-9801BX3(CPUを486DX2-66MHzに換装)にOSDとFD1155Dを接続し、FDX68 Version 1.2A、RasPi OS buster 2021-01-11版使用にて動作確認を行っています。<br><br>

<b>2. 制限事項</b><BR>
このボードは簡素なつくりのため、FDS+と比べ機能制限が多いです。エミュレーションモードでのドライブ番号(0のみ、1のみ、0/1両方)はジャンパーで設定するようになっており、動的な変更はできません。また、PC-98における2DDディスクの回転数が他のシステムと異なるため、2DDディスクの扱いにも制限があります。<br><br>

<b>3. 免責など</b><br>
ここで公開している内容はありのまま(As Is)で提供するものであり、動作を保証するものではありません。また、使用したことによりお手持ちの機器などにダメージを与える可能性もあります。私個人が金銭的、身体的損害について補償することはできませんので、ご利用は個人の責任において行ってください。<br><br>
  
<b>4. ファイルの配置</b><BR>
KiCad : KiCadプロジェクトファイル<BR>
KiCad/garber : ガーバーファイル<BR>
Tiny13 : マイコン(ATtiny13A)のファームウェア(AtmelStudio用ソース)<BR>
Firmware : マイコン(ATtiny13A)のファームウェア(Intel Hex形式バイナリ)<BR>
　ヒューズ設定はビットはfuse.hex<BR>
preview.png : 基板のプレビューイメージ<BR>
scheme.png : 基板回路図<BR><br>
  
<b>5. 接続方法</b><BR>
マザーボードとの接続用(J1)および3.5インチFDD接続用(J2)のコネクターは30ピンタイプ(A-MateやFellowのマザーボードコネクターと同じタイプ)を、FDX68接続用(J3)および5インチFDD接続用(J4)のコネクターは34ピンタイプ(一般的なマザーボード上34ピンFDDコネクターと同じタイプ)を使用しています。いずれも左上(印のついている)ピンが1番ピンになっていますので、向きを間違えないように接続してください。J1, J3には<b>反転していない</b>ストレートのケーブルを使用します。FDX68のコネクターは一般的なPC-98用3.5インチFDDとは向きが逆になっていますので注意してください。マザーボードとの接続は、同じ30ピンのコネクターを搭載している機種であれば単純なストレートのケーブルでOKですが、34ピンのコネクター搭載機種だと変換ケーブルの作成が必要です。その場合、基板への電源供給ができませんので、変換ケーブルを作成する際にVCCピン(1,3,5)に電源を接続するか、操作スイッチなどを接続するJ5のVCC("+"表示のある1番ピン)から電源を供給するようにしてください。<BR><BR>
なお、J5(操作スイッチ接続コネクター)のピンアサインは下記のとおりです。<BR><BR>
Pin 1 (+) : VCC (J1のVCCピンと直結)<BR>
Pin 2 (L) : モード表示LED出力(Active Low)<BR>
Pin 3 (S) : 操作ボタン入力(Active Low)<BR>
Pin 4 (I) : RasPi電源検知入力(Active High)<BR>
Pin 5 (-) : GND<BR><BR>
モード表示LEDはアノードをVCC(Pin 1)に、カソードをLED出力(Pin 2)に接続します。電流制限抵抗は基板上にあるため(R2)外付けは不要です。また、操作ボタン(タクトスイッチなどでOKです)はボタン入力(Pin 4)とGND(Pin 5)の間に接続します。プルアップ抵抗などは不要です。Pin 4はFDX68(Raspberry Pi)の電源状態を検知して自動的にモードを切り替えるための入力で、Raspberry PiあるいはFDX68シールドの+5V端子を接続すればよいのですが、後述のジャンパー設定にてOPT2端子を検知に使用する場合には使用する必要はありません。また、電源検知機能を使用したくない場合にはソースコード settings.h の "#define PWRSENS 2" の行をコメントアウトしてコンパイルしてください。<BR><br>
 
<b>6. 設定用ジャンパー</b><br>
基板上のジャンパー(ピンヘッダー、はんだジャンパー)の一覧です。<br><br>
JP1 : PWR_SENS<br>
　電源検知機能を使用する場合に、検知用の信号をOPT2から取りたい場合にショートします。<br>
　FDX68のID設定を0,1とするとOPT2端子は電源ON時常にプルアップ状態になることを利用しています。<br>
JP2 : DS1 Select<br>
JP3 : DS0 Select<br>
　エミュレーションモード、およびノンエミュレーションモードにおいて、マザーボードからの<br>
　Drive select(DS) 0/1信号を3.5インチFDDとFDX68(or 5インチFDD)のどちらに接続するかを設定します。<br>
　コントローラーモードにおいてはマザーボードからのDS信号が切り離され、DS0/1いずれもFDX68に<br>
　直結されます。<br>
　FDX側をショートするとエミュレーションモードにおいて当該ドライブ番号側がエミュレートされます。<br>
　また、後述のノンエミュレーションモードにおいては5インチFDDが選択されるようになります。<br>
　3.5FD側をショートすると、当該ドライブ番号側は常に3.5インチFDDが選択されるようになります。<br>
JP4 : P4 SELECT (MS0)<br>
　FDX68のPin4を3.5インチFDDのMode Select(MS) 0に接続したい場合にショートします。<br>
　これを利用すると、3モードFDDを利用して1.44MBのFDのダンプ、リストアができるようになります。<br>
　この機能を利用して1.44MBのFDを扱うにはダンプ、リストア時に"-p4"オプションを指定すればOKです。<br>
　また、この機能は3.5インチFDD 0でのみ使用可能です(MS1には未接続のため)。<br>
JP6 : P4 SELECT (HL)<br>
　FDX68のPin4を5インチFDDのHead Load(HL)に接続し、コントローラーモード"-p4"オプションで<br>
　制御したい場合にショートします。<br>
　この基板では5インチFDDのHL端子をマザーボードと接続していませんので、通常はドライブ側でHL機能を<br>
　無効化してください。<br>
JP7 : HL<br>
　5インチFDDのPin4(HL/In Use)をGNDに落としたい場合にショートします。<br>
　HLを無効化したFDDでアクセスランプが点かない場合に、ショートすることにより点くようになることが<br>
　多いかと思います。<br>
  
<b>7. FDDタイプ別設定例</b><br>
以下にFDDのタイプ別の接続方法、設定方法を示します。PC-98用FDDでは2DDのディスクアクセス時に回転数が360rpmとなっており、他のシステムとは回転数が異なっています。FDX68のダンプ、リストアにおいては2D/2DDモードにおける回転数は300rpmであることが前提となっており、ドライブ側が360rpmで回転していることを検知するとエラーとなってしまいます。このため、2D/2DDモード時の回転数の設定ができる5インチFDDにおいては300rpmに設定する必要がありますが、その場合には本体側からの2DDディスクのアクセスはできなくなってしまいます。まだ一部の3モードFDDにおいては2DDモードで300rpmに設定できる(MS, Densityともアサートする)ことを確認しておりますが、その場合FDからのデータ読み込みエラーが多発しますし、書き込みはまずできない(読めないディスクができてしまう)ので、実用的ではありません。MSXにFD1231TやOSDを接続する実験においては、数台のドライブで試したところ、2DD/300rpmで読み込みが何とかできるものもありましたが、書き込みは全滅でした。ドライブの個体差にもよると思うのでものによってはダンプのみなら何とかできる可能性がありますが、基本的にはFDX68のコントローラーモードとPC-98用3.5インチFDDの組み合わせで2D/2DDディスクを扱うのは困難であると考えています。このような用途にはAT互換機用FDDを使う必要があるのかもしれません。<br><br>
<b>a. 3.5インチFDD×1台のみの場合</b><br>
26ピンのFDD(FD1138Tなど)であればA-Mate, Fellowなどに使用されている30ピン-26ピンケーブルで接続しますが、34ピンコネクターを持つFDD(FD1231Tなど)では変換ケーブルが必要となります。2股ケーブルを使用することによりDrive0, Drive1いずれにも設定可能です。JP2/3はFDDに設定したドライブ番号側を3.5FDに、そうでない側をFDXに設定します。<br><br>
<b>b. 3.5インチFDD×2台の場合(1)</b><br>
2股ケーブルを使用することで2台ともJ2に接続することも可能ですが、その場合機能の組み合わせに制限が生じます。<br>
JP2/3を3.5FD側に設定したドライブ番号：本体から認識可能　エミュレーション利用不可<br>
JP2/3をFDX側に設定したドライブ番号：本体から認識不可　エミュレーション利用可能<br>
いずれのドライブもコントローラーモードでFDX68側から制御することは可能です("-i"オプションでドライブ番号を指定)<br><br>
<b>c. 3.5インチFDD×2台の場合(2)</b><br>
応用として、あえて片方をJ4(5インチFDD接続用)に接続するという方法があります。J4に接続したドライブは3モードでの利用はできませんが、ノンエミュレーションモードにて2ドライブとも本体から認識可能となります。この方法を利用する場合、HL機構を持たないドライブではJP7はオープンでよいと思います。接続ケーブルはFD1231Tなどで使用されている、マザーボード側とFDD側でコネクターの向きが反転したケーブルでよいと思いますが、FDD側のコネクターの向きをよく確認するようにしてください。また、3モードFDDを使用する場合にはケーブルの1番ピンをカットする必要があります(結果的に1.44MBの2HDディスクは利用できなくなります)。JP2/JP3設定は下記のようにします。<br>
J2に接続したドライブ(DS0/1)を3.5FD側に設定、J4に接続したドライブ(DS1/0)をFDX側に設定<br>
以上の設定で、ノンエミュレーションモードでは2台ともアクセス可能、エミュレーションモードではJ2側のFDD+FDX68、コントローラーモードでは2台とも制御可能となります。<br><br>
<b>d. 3.5インチFDD×1台+5インチFDD×1台の場合</b><br>
もともとこの基板はこの組み合わせて使用することを想定して設計し、動作確認もOSD-U+FD1155Dを各1台接続して行っています。基本的な設定、接続はc.と同じですが、ケーブルを用意するにあたっては5インチFDDのコネクターの向きに注意してください。以下に動作確認済み5インチFDDにおけるジャンパー設定内容を示します。なお、上記のとおりFDX68では2D/2DDのディスクは300rpmで使用することが前提となっているため、下記の設定ではそうしています(HDE=2)。ただし、その場合にはノンエミュレーションモードにて本体から2D/2DDディスクを読み書きすることはできなくなります。<br><br>
FD1155(無印)<BR>
　DX=ドライブ番号 USE=2 MON=1 HS=1 LED=1+5<br>
　本基板上のJP7はショートしておいてください<br>
FD1155D(タイプ1)<br>
　USEジャンパーを2にした場合にアクセスランプが点灯しなくなるタイプはこちら<br>
　DX=ドライブ番号 USE=2 MON=1 RD=1 DCG=1 HDE=2 DEN=1<br>
　本基板上のJP7をショートするとアクセスランプが点灯するようになります<br>
　ただし、そうするとアクセスしていないときにもうっすらと点灯する場合がありますが、<br>
　これは故障ではありません。<br>
　(アクセスしていないときにも一定間隔でDS信号がアサートされている場合があるため)<br>
FD1155D(タイプ2)<br>
　USEジャンパーを2にした場合にもアクセスランプが適切に点灯するタイプはこちら<br>
　DX=ドライブ番号 USE=2 MON=1 <b>RD=2</b> DCG=1 HDE=2 DEN=1<br>
　RDジャンパーを2に設定することによりFDDに内蔵のVFOが有効化されてしまいますが<br>
　このように設定しないとコントローラーモードでのリストアに失敗します<br>
　RD=2にするとダンプ及び本体からのアクセスができなくなりますが、<br>
　J4のPin 3/7/11をGNDとショートすることによりVFOが無効化されアクセスできるようになります<br>
　また、当方で確認した限りではGNDにショートしてもリストア動作に支障はありませんでした<br><br>
このほかにも接続方法はいろいろと考えられます。回路図や下記の各モードでの動作をご理解のうえご検討いただければと思います。<br><br>

<b>8. 動作モード</b><br>
この基板には以下の3つの動作モードがあります。それぞれの動作および信号線の切り替え内容について解説します。切り替えを行っているのはDS0/1, Motor On(MON), Readyのみで、基本的に他の信号線は直結してあります(MS0/1およびHLはマザーボード-3.5インチFDD間のみ)。<br><br>
<b>a. ノンエミュレーションモード(LED消灯)</b><br>
DS0/1, MON, Readyがマザーボード－3.5インチFDD－5インチFDD(－FDX68)まですべて直結されます。結果として3.5インチFDD, 5インチFDDともに本体から通常通りアクセスできるようになります。このモードではFDX68の電源が入っていると誤動作する可能性があるので、FDX68の電源を切った状態で使用してください。<br><br>
<b>b. エミュレーションモード(LED点灯)</b><br>
MON, Readyがマザーボード－3.5インチFDD－FDX68まで接続され、5インチFDDは切り離されます。DS0/1はJP2/3によって接続先が設定されます。結果として3.5インチFDD, およびFDX68が本体からアクセスできるようになります。ドライブ0/1のどちらにFDD, FDX68を割り当てるかをJP2/3を用いて設定します。<br><br>
<b>c. コントローラーモード(LED点滅)</b><br>
DS0/1, MON, Readyが3.5インチFDD－FDX68－5インチFDDまで接続され、マザーボードは切り離されます。結果として3.5インチFDD, および5インチFDDがFDX68からアクセスできるようになり、ダンプ、リストア操作が可能となります。<br><br>
  
<b>9. 基本的な操作方法</b><br>
初回起動時(電源ON時)には、FDX68の電源が入っておればエミュレーションモード、入っていなければノンエミュレーションモードで起動します。その後は下記の操作でモードの切り替えが可能です。<br><br>
操作ボタン短押し：エミュレーションモード←→コントローラーモードの切り替え(トグル)<br>
操作ボタン長押し：ノンエミュレーションモードに切り替え(約3秒、LEDが一瞬点滅するまで押してください)<br>
FDX68 電源ON：エミュレーションモードに切り替え<br>
FDX68 電源OFF：ノンエミュレーションモードに切り替え<br><br>

<b>10. 既知の問題点</b><br>
概ね設計どおりの動作を確認してはいますが、 こちらの動作確認環境(PC-9801BX3+OSD)では1.44MBモードでの動作がやや不安定です。具体的には、エミュレーションモードにて1.44MBのイメージをマウントし、そのイメージに書き込むと読めないセクターができてしまうことがありました。また、1.44MBのディスクのダンプは特に問題なくできましたが、リストアを行うと一部にエラーのあるディスクができてしまうことがありました。このボードの設計というよりは、FDDやマザーボードとFDX68の相性なのかもしれないと考えています。<br><br>
  
このボードの開発中に実施した各種の実験や、FDX68に関連したツイートを下記にまとめております。興味のある方はご覧ください。
https://min.togetter.com/ba5qN4b
